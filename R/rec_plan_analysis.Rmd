---
title: "ESA recovery plans: time from listing to final recovery plans"
author: "Jacob Malcom"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_document:
    fig_caption: yes
    toc: true
    toc_depth: 3
    toc_float: true
---

<script async defer src="https://hypothes.is/embed.js"></script>

```{r setup, include = FALSE}
library(ecosscraper)
library(dplyr)
library(ggplot2)
library(ggthemes)
library(knitr)
library(lubridate)
library(plotly)
library(stringr)
library(viridis)
data("recovery_plan_table")
data("species_info_table")
```

## Introduction

The U.S. Endangered Species Act (ESA) requires the Fish and Wildlife and National Marine Fisheries Services develop plans to guide the recovery of listed species, unless doing so is not warranted (e.g., for foreign listed species). Recovery plans have evoloved significantly over the years, as has recovery planning guidance the Services use. Since 1994 the Services' [guidance](http://www.nmfs.noaa.gov/pr/pdfs/fr/fr59-16024.pdf) has stated that recovery plans would be completed within 2-1/2 years. But we know a persistent problem is that recovery planning often takes far longer than that. 

As part of ongoing work, we scraped the tables from all of FWS's [ECOS website](http://ecos.fws.gov). With the data from the scraping, we can answer several outstanding questions. What is the average or median time from listing to a final recovery plan? What proportion of species have plans completed within the 2.5-year time-frame? How has the time required for a recovery plan changed over the past >40 years? Is there variation in time-to-recovery plan among FWS regions or between the Services?

```{r joins, echo = FALSE}
combo <- dplyr::left_join(recovery_plan_table,
                          species_info_table,
                          by = "Species")
names(combo)[1] <- "Rec_Plan_Date"
combo$Rec_Plan_Date <- as.Date(combo$Rec_Plan_Date)
names(combo)[8] <- "Date_Listed"
combo$Date_Listed <- as.Date(combo$Date_Listed)
combo$Date_Delta <- as.numeric(combo$Rec_Plan_Date - combo$Date_Listed)
```

## First glance

Before doing anything, we take a look at the distribution of durations.

```{r echo=FALSE, warning=FALSE, message=FALSE}
qplot(combo$Date_Delta / 365, geom = "histogram") +
      labs(x = "Years between date listed and recovery plan date") +
      ggtitle("Time to recovery plan", 
              subtitle = "From ECOS tables") +
      theme_hc() +
      theme(plot.title=element_text(hjust = 0, size = 18))
```

There's clearly something off about this data. A significant number of records have a time of zero or fewer days between listing and the recover plan date. Looking even at the top few rows of data, it's pretty clear that the reason is the most-recent listing decision date is presented at the top of ECOS. To get the original listing dates, we can mine the Federal Register notices data (also scraped from ECOS). What about species with very long times? Looking at those data, it appears that most, but not all, are high in part because they are revisions. 

## Data cleaning

The top table for each species on ECOS includes a "Date Listed," but that date is _only the most recent date of a listing status change_. For example, if a species is up- or down-listed, or if an Experimental population is listed, then that most-recent date is used. But we're interested in the original listing date because it is from that time when the Services should start recovery planning. 

We can use the Federal Register table scraped from ECOS to try to get the original listing date for each species; we just have to find which FR notice corresponds to the listing. Unfortunately, there are >21K FR entries to sort through, and there is no single FR heading that indicates the final rule. But with a bunch of pattern matching and excluding, we can get a pretty good estimate.

Below is the code used to clean the data:

```{r est_orig_list}
data("federal_register_table")
t1 <- filter(federal_register_table, 
             grepl(federal_register_table$Title, 
                   pattern = "Determination|Determined|Listing|Listed as|Status|Endangered Species List|to be End|to be Thr|Appendix D|Final Rule for|Part 17|List[s]+ of Endangered|Amendments to List of Endangered Fish and Wildlife|Final Rule to List|Technical Corrections for Eight Wild|Emergency Rule to List|Addition.*List of End",
                   ignore.case = TRUE))
t2 <- filter(t1, 
             !grepl(t1$Title, 
                    pattern = "Notice of Review|Supplement to Review|Review of|Review for|Findings on|Proposed|Proposal|Status Rev",
                    ignore.case = TRUE))
# head(t2$Title, 10)
# dim(t2)
# spp_cov <- unique(t2$Species)
# setdiff(unique(recovery_plan_table$Species), spp_cov)

t2$Date <- as.Date(t2$Date)
earliest <- aggregate(Date ~ Species, t2, min, na.rm = TRUE) 
kable(head(earliest, 5), align = c("l", "c"))
```

```{r upd_list_date}
updated <- left_join(combo, earliest, by = "Species")
updated$List_Diff <- as.numeric(updated$Date_Listed - updated$Date)
diff <- filter(updated, updated$List_Diff > 45)

orig_ls <- as.Date(rep("2000-01-01", length(updated$Title)))
for(i in 1:length(orig_ls)) {
  if(!is.na(updated$List_Diff[i]) & updated$List_Diff[i] > 45) {
    orig_ls[i] <- updated$Date[i]
  } else {
    orig_ls[i] <- updated$Date_Listed[i]
  }
}
updated$Orig_List <- orig_ls
updated$Upd_Elapsed <- as.numeric(updated$Rec_Plan_Date - updated$Orig_List)
updated$Orig_Elapsed <- as.numeric(updated$Rec_Plan_Date - updated$Date_Listed)
```

With the initial cleaning, and looking only at the records with a `Final` recovery plan, we have a new distribution:

```{r upd_dist, echo = FALSE, message = FALSE}
final <- filter(updated, updated$`Plan Status` == "Final")
neg <- filter(final, final$Upd_Elapsed <= 0)

qplot(final$Upd_Elapsed / 365, geom = "histogram") +
      labs(x = "Years between date listed and recovery plan date") +
      ggtitle("Time to recovery plan", 
              subtitle = "with original listing dates") +
      theme_hc() +
      theme(plot.title=element_text(hjust = 0, size = 18))
```

Clearly the negative values are errors...except they're not all errors. Some species were listed _after_ the recovery plan they are a part of was written. Based on an initial examination, these valid negative years species tend to be part of multi-species plans, e.g., [Ohlone tiger beetle](https://ecos.fws.gov/ecp0/profile/speciesProfile?spcode=I0OW). But some are errors, e.g., Ring Pink (Mussel), which has a 1991 recovery plan and an experimental population listed in 2007. Further inspection shows that almost all of these errors are for experimental populations, so we should exclude those as well.

```{r no_exp, echo = FALSE, message = FALSE}
no_exp <- filter(final, !grepl(final$Status, pattern = "Experimental"))
neg <- filter(no_exp, no_exp$Upd_Elapsed <= 0)

qplot(no_exp$Upd_Elapsed / 365, geom = "histogram") +
      labs(x = "Years between date listed and recovery plan date") +
      ggtitle("Time to recovery plan", 
              subtitle = "no experimental populations") +
      theme_hc() +
      theme(plot.title=element_text(hjust = 0, size = 18))
```

I think this is the valid final data set (n = `r dim(no_exp)[1]`), and all of the negative values (n = `r dim(neg)[1]`) appear to be correct. A summary of the data:

```{r save_dat, echo = FALSE}
# filtered_recplan_df <- no_exp
# save(filtered_recplan_df, file = "data/filtered_recplan_df.rda")
```

```{r fin_summary, echo = FALSE}
tmp <- list(n = length(no_exp$Date_Delta),
            min = min(no_exp$Date_Delta, na.rm = TRUE),
            median = median(no_exp$Date_Delta, na.rm = TRUE),
            mean = mean(no_exp$Date_Delta, na.rm = TRUE),
            max = max(no_exp$Date_Delta, na.rm = TRUE))
kable(as.data.frame(tmp), 
      caption = "Summary statistics of time between listing and final recovery plan. Min, median, mean, and max are given in days.",
      digits = 1,
      align = "c")
```

## Percentiles

One question that can be addressed with a dynamic plot is, _What percentage of recovery plans are completed in X years?_

```{r percentile, echo = FALSE, message = TRUE}
duration <- sort(no_exp$Upd_Elapsed / 365, decreasing = FALSE)
order <- seq(1:length(duration))
percentile <- order / max(order)
pctile <- data.frame(duration, order, percentile, stringsAsFactors = FALSE)

gg <- ggplot(pctile, aes(y = duration, x = percentile)) +
        geom_line() +
        ggtitle("Time to recovery plan", 
                subtitle = "As a function of quantiles") +
        labs(x = "Percentile",
             y = "Time-to-recovery plan (years)\n") +
        theme_hc() + 
        theme(text = element_text(family = "Open Sans"))

ggplotly(gg) %>% layout(font = list(family = "Open Sans"))
```

With this we can quickly say that about 50% of plans are finalized within 4.7 years of the species' listing, 19% are completed within the 2.5 years the Services allot themselves, and 95% are finalized within 20 years.

## Time-to-recovery plan over the years

How has the time it takes to write and finalize a recovery plan changed over the years?

```{r thru_time, echo = FALSE, message = FALSE}
tmp <- no_exp
tmp$list_yr <- year(tmp$Orig_List)
avg <- aggregate(Upd_Elapsed / 365 ~ list_yr, tmp, mean, na.rm = TRUE)
min <- aggregate(Upd_Elapsed / 365 ~ list_yr, tmp, min, na.rm = TRUE)
max <- aggregate(Upd_Elapsed / 365 ~ list_yr, tmp, max, na.rm = TRUE)
dat <- cbind(avg, min, max)
dat <- dat[, c(1,2,4,6)]
names(dat) <- c("Year", "Mean", "Min", "Max")

ggplot(dat, aes(y = Mean, x = Year)) +
  geom_line() +
  geom_line(aes(y = Min, x = Year), colour = "gray70") +
  geom_line(aes(y = Max, x = Year), colour = "gray70") +
  ggtitle("Time to recovery plan through the years", 
          subtitle = "Min and max in gray") +
  labs(x = "Year",
       y = "Time-to-recovery plan (years)\n") +
  theme_hc() + 
  theme(text = element_text(family = "Open Sans"))
```

## By region and agency

A question that comes to mind is the duration by lead region (or agency, for NMFS). Will focus on just the positive values for the moment:

```{r by_region, echo = FALSE, warning = FALSE}
tmp$Region <- stringr::str_match(tmp$`Lead Region`, 
                                     pattern = "\\([A-Za-z0-9 ]+\\)")
tmp$Region <- stringr::str_replace(tmp$Region,
                                   "National Marine Fisheries Service",
                                   "NMFS")
tmp$Region <- stringr::str_replace(tmp$Region, "\\(", "")
tmp$Region <- stringr::str_replace(tmp$Region, "\\)", "")

ggplot(tmp, aes(y = tmp$Date_Delta / 365, x = tmp$Region)) +
  geom_violin(fill = "gray", alpha = 0.5, colour = NA) +
  geom_boxplot(colour = "gray20", fill = NA) +
  labs(x = "", y = "Time-to-Recovery Plan (years)") +
  ggtitle("Time to recovery plan by region", 
          subtitle = "From ECOS tables") +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  theme_hc()

tmp <- as.data.frame(table(tmp$Region))
names(tmp) <- c("Region/Agency", "# Plans")
kable(tmp, caption = "Distribution of plans (with positive time-to-plan) among FWS regions and agencies", align = "c")
```


